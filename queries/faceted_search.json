{

  "from": 0,
  "size": 10,

  "query": {
    "bool": {
      "must": [
        { "term" : { "color" : "RED" }  },
        { "term" : { "brand_keyword" : "HORSEFEATHERS" }  },
        {     "nested" : {
          "path" : "price",
          "query" : {
            "bool" : {
              "must" : [
                { "match" : {"price.pricelist" : "RRP-EUR"} },
                { "range" : {"price.final" : {"gt" : 50, "lt": 200}} }
              ]
            }
          }
        }
        }
      ]
    }
  },

  "aggs": {
    "prices" : {
      "nested": { "path": "price" },
      "aggs" : {
        "filtered_prices": {
          "filter" : { "term": { "price.pricelist" : "RRP-EUR" } },
          "aggs" : {
            "min_price" : { "min" : { "field" : "price.final" } },
            "max_price" : { "max" : { "field" : "price.final" } }
          }
        }
      }
    },
    "discounts" : {
      "nested": { "path": "price" },
      "aggs" : {
        "filtered_discounts": {
          "filter" : { "term": { "price.pricelist" : "RRP-EUR" } },
          "aggs" : {
            "min_price" : { "min" : { "field" : "price.discount" } },
            "max_price" : { "max" : { "field" : "price.discount" } }
          }
        }
      }
    },
    "color": {
      "terms": { "field": "color" }
    },
    "brand": {
      "terms": { "field": "brand_keyword" }
    },
    "new": {
      "terms": { "field": "flag_new" }
    },
    "discounted": {
      "terms": { "field": "flag_discounted" }
    },
    "variant" : {
      "nested" : { "path" : "variant" },
      "aggs" : {
        "size" : { "terms" : { "field" : "variant.size" } }
      }
    }
  },

  "sort": { "brand_keyword" : { "order": "asc" } },

  "_source": [ "title",
    "brand"
  ]

}

